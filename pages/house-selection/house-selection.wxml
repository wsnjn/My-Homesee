<!--pages/house-selection/house-selection.wxml-->
<view class="house-selection-container">
  <!-- 搜索栏 -->
  <view class="search-bar">
    <view class="search-input-container">
      <input 
        class="search-input" 
        placeholder="搜索房源..."
        value="{{searchKeyword}}"
        bindinput="onSearch"
      />
      <view class="search-icon-wrapper">
        <svg-icon name="search" size="20" color="#9CA3AF" />
      </view>
    </view>
    <button class="filter-btn" bindtap="toggleFilterPanel">
      <svg-icon name="filter" size="20" color="#FFFFFF" />
      筛选
    </button>
  </view>

  <!-- 排序选项 -->
  <view class="sort-options">
    <view 
      wx:for="{{sortOptions}}" 
      wx:key="id" 
      class="sort-option {{currentSort === item.id ? 'active' : ''}}"
      bindtap="selectSort"
      data-index="{{item.id}}"
    >
      {{item.name}}
    </view>
  </view>

  <!-- 筛选面板 -->
  <view wx:if="{{showFilterPanel}}" class="filter-panel">
    <view class="filter-header">
      <text class="filter-title">筛选条件</text>
      <button class="reset-btn" bindtap="resetFilters">重置</button>
    </view>
    
    <scroll-view scroll-y class="filter-content">
      <!-- 区域选择 -->
      <view class="filter-section">
        <view class="filter-label">区域选择</view>
        <!-- 省份和城市在同一行 -->
        <view class="filter-row-horizontal">
          <picker mode="selector" range="{{provinces}}" value="{{selectedProvinceIndex}}" bindchange="onProvinceChange" class="picker-half">
            <view class="picker-item">{{selectedProvince || '省份'}}</view>
          </picker>
          <picker mode="selector" range="{{cities}}" value="{{selectedCityIndex}}" bindchange="onCityChange" class="picker-half">
            <view class="picker-item">{{selectedCity || '城市'}}</view>
          </picker>
        </view>
        <!-- 区县和街道在同一行 -->
        <view class="filter-row-horizontal">
          <picker mode="selector" range="{{districts}}" value="{{selectedDistrictIndex}}" bindchange="onDistrictChange" class="picker-half">
            <view class="picker-item">{{selectedDistrict || '区县'}}</view>
          </picker>
          <picker mode="selector" range="{{streets}}" value="{{selectedStreetIndex}}" bindchange="onStreetChange" class="picker-half">
            <view class="picker-item">{{selectedStreet || '街道'}}</view>
          </picker>
        </view>
        <!-- 小区单独一行 -->
        <picker mode="selector" range="{{communities}}" value="{{selectedCommunityIndex}}" bindchange="onCommunityChange">
          <view class="picker-item">{{selectedCommunity || '小区'}}</view>
        </picker>
      </view>

      <!-- 基本筛选 -->
      <view class="filter-section">
        <view class="filter-label">基本筛选</view>
        <!-- 租赁类型和装修程度在同一行 -->
        <view class="filter-row-horizontal">
          <picker mode="selector" range="{{rentalTypeOptions}}" range-key="label" value="{{selectedRentalTypeIndex}}" bindchange="onRentalTypeChange" class="picker-half">
            <view class="picker-item">{{selectedRentalType || '租赁类型'}}</view>
          </picker>
          <picker mode="selector" range="{{decorationOptions}}" range-key="label" value="{{selectedDecorationIndex}}" bindchange="onDecorationChange" class="picker-half">
            <view class="picker-item">{{selectedDecoration || '装修程度'}}</view>
          </picker>
        </view>
        <!-- 电梯和朝向在同一行 -->
        <view class="filter-row-horizontal">
          <picker mode="selector" range="{{elevatorOptions}}" range-key="label" value="{{selectedElevatorIndex}}" bindchange="onElevatorChange" class="picker-half">
            <view class="picker-item">{{selectedElevator || '电梯'}}</view>
          </picker>
          <picker mode="selector" range="{{orientationOptions}}" range-key="label" value="{{selectedOrientationIndex}}" bindchange="onOrientationChange" class="picker-half">
            <view class="picker-item">{{selectedOrientation || '朝向'}}</view>
          </picker>
        </view>
      </view>

      <!-- 价格与面积 -->
      <view class="filter-section">
        <view class="filter-label">价格与面积</view>
        <view class="range-inputs">
          <view class="range-group">
            <input type="number" placeholder="最低租金" value="{{minPrice}}" bindinput="onMinPriceInput" />
            <text class="range-divider">-</text>
            <input type="number" placeholder="最高租金" value="{{maxPrice}}" bindinput="onMaxPriceInput" />
          </view>
          <view class="range-group">
            <input type="number" placeholder="最小面积" value="{{minArea}}" bindinput="onMinAreaInput" />
            <text class="range-divider">-</text>
            <input type="number" placeholder="最大面积" value="{{maxArea}}" bindinput="onMaxAreaInput" />
          </view>
        </view>
      </view>
    </scroll-view>

    <view class="filter-actions">
      <button class="cancel-btn" bindtap="toggleFilterPanel">取消</button>
      <button class="apply-btn" bindtap="applyFilters">应用</button>
    </view>
  </view>

  <!-- 房屋列表 -->
  <scroll-view 
    class="house-list" 
    scroll-y 
    bindscrolltolower="onReachBottom"
    enable-back-to-top
  >
    <view wx:if="{{houses.length === 0 && !loading}}" class="empty-state">
      <view class="empty-icon-wrapper">
        <svg-icon name="empty" size="80" color="#ccc" />
      </view>
      <text class="empty-text">暂无房源</text>
      <text class="empty-hint">尝试调整筛选条件或搜索关键词</text>
    </view>

    <view wx:for="{{houses}}" wx:key="id" class="house-card">
      <!-- 房屋图片 -->
      <view class="house-image-wrapper" hover-class="house-image-wrapper-hover" hover-stay-time="100">
        <image 
          class="house-image" 
          src="{{item.coverImage || '/images/models/客厅.jpg'}}" 
          mode="aspectFill"
        />
        <!-- 标签组：左上角 -->
        <view class="house-tags">
          <view class="tag status-tag {{item.status === 0 ? 'status-available' : 'status-unavailable'}}">
            {{item.status === 0 ? '在租' : '已下架'}}
          </view>
          <view class="tag type-tag">
            {{item.rentalType === 0 ? '整租' : (item.rentalType === 1 ? '合租' : '单间')}}
          </view>
        </view>
        <!-- VR看房按钮：手指按住时显示 -->
        <view class="vr-overlay">
          <button 
            class="vr-tour-btn" 
            catchtap="goToHouseTour" 
            data-id="{{item.id}}"
          >
            VR看房
          </button>
        </view>
      </view>

      <!-- 房屋信息 -->
      <view class="house-info">
        <!-- 标题 -->
        <view class="house-title">{{item.district}} {{item.doorNumber || ''}}</view>
        
        <!-- 地址 -->
        <view class="house-address">
          <svg-icon name="location" size="28" color="#6B7280" />
          <text>{{item.city}}{{item.district}}{{item.street}}</text>
        </view>
        
        <!-- 房东电话 -->
        <view wx:if="{{item.landlordPhone}}" class="landlord-phone">
          <svg-icon name="phone" size="28" color="#6B7280" />
          <text>房东电话: {{item.formattedPhone || item.landlordPhone}}</text>
        </view>
        
        <!-- 房屋规格 -->
        <view class="house-meta">
          <text class="meta-item">{{item.roomArea}}㎡</text>
          <text class="meta-divider">|</text>
          <text class="meta-item">{{item.floorInfo || '中层'}}</text>
          <text class="meta-divider">|</text>
          <text class="meta-item">{{item.decoration === 1 ? '毛坯' : (item.decoration === 2 ? '简装' : (item.decoration === 3 ? '精装' : '豪装'))}}</text>
        </view>
        
        <!-- 底部：价格和操作按钮 -->
        <view class="house-footer">
          <view class="price-container">
            <text class="price-symbol">¥</text>
            <text class="price-value">{{item.rentPrice}}</text>
            <text class="price-unit">/月</text>
          </view>
          <button 
            class="action-btn appointment-btn {{item.status !== 0 ? 'disabled' : ''}}" 
            catchtap="goToAppointment" 
            data-id="{{item.id}}"
            data-status="{{item.status}}"
          >
            {{item.status === 0 ? '预约看房' : '已下架'}}
          </button>
        </view>
      </view>
    </view>

    <!-- 加载状态 -->
    <view wx:if="{{loading}}" class="loading-container">
      <text class="loading-text">加载中...</text>
    </view>
    
    <view wx:if="{{!hasMore && houses.length > 0}}" class="no-more-container">
      <text class="no-more-text">没有更多房源了</text>
    </view>
  </scroll-view>

  <!-- 筛选遮罩 -->
  <view 
    wx:if="{{showFilterPanel}}" 
    class="filter-mask" 
    bindtap="toggleFilterPanel"
  ></view>
</view>
