<!--pages/user-profile/user-profile.wxml-->
<view class="profile-container">
  <!-- Navigation Bar -->
  <view class="navbar">
    <view class="nav-left" bindtap="goBack">
      <svg-icon name="arrow-left" size="24" color="#111827" />
    </view>
    <view class="nav-center">个人信息</view>
    <view class="nav-right">
      <view wx:if="{{isEditing}}" class="action-buttons">
        <button class="btn cancel-btn" bindtap="cancelEdit">取消</button>
        <button class="btn save-btn" bindtap="saveUserInfo" loading="{{saveLoading}}">保存</button>
      </view>
    </view>
  </view>

  <scroll-view scroll-y class="content-scroll">
    <view class="content-wrapper">
      
      <!-- Avatar Section -->
      <view class="info-card avatar-card">
        <view class="avatar-section">
          <view class="avatar-wrapper" bindtap="chooseAvatar">
            <image 
              class="avatar-img" 
              src="{{user.avatar && user.avatar.length > 0 ? (user.avatar.indexOf('http') === 0 ? user.avatar : 'https://files.homesee.xyz/api/files/download/' + user.avatar) : 'https://files.homesee.xyz/api/files/download/default-avatar.png'}}" 
              mode="aspectFill"
            ></image>
            <view class="avatar-overlay">
              <svg-icon name="camera" size="32" color="#FFFFFF" />
            </view>
          </view>
          <view class="avatar-tip">点击更换</view>
        </view>
      </view>

      <!-- Basic Info -->
      <view class="info-card">
        <view class="card-title">基本信息</view>
        <view class="info-grid">
          <view class="info-item">
            <text class="label">用户名</text>
            <view wx:if="{{!isEditing || editingField !== 'username'}}" 
                  class="value {{!user.username ? 'placeholder' : ''}}" 
                  bindtap="startEditField" data-field="username">
              {{user.username || '未设置'}}
            </view>
            <input wx:else class="edit-input" value="{{editForm.username}}" 
                   bindinput="handleInput" data-field="username" focus />
          </view>

          <view class="info-item">
            <text class="label">真实姓名</text>
            <view wx:if="{{!isEditing || editingField !== 'realName'}}" 
                  class="value {{!user.realName ? 'placeholder' : ''}}" 
                  bindtap="startEditField" data-field="realName">
              {{user.realName || '未设置'}}
            </view>
            <input wx:else class="edit-input" value="{{editForm.realName}}" 
                   bindinput="handleInput" data-field="realName" focus />
          </view>

          <view class="info-item">
            <text class="label">手机号</text>
            <view class="value disabled">{{user.phone}}</view>
          </view>

          <view class="info-item">
            <text class="label">用户类型</text>
            <view class="value disabled">{{userTypeMap[user.userType]}}</view>
          </view>
        </view>
      </view>

      <!-- Identity Info -->
      <view class="info-card">
        <view class="card-title">身份信息</view>
        <view class="info-grid">
          <view class="info-item">
            <text class="label">性别</text>
            <view wx:if="{{!isEditing || editingField !== 'gender'}}" 
                  class="value" 
                  bindtap="startEditField" data-field="gender">
              {{genderMap[user.gender]}}
            </view>
            <picker wx:else mode="selector" range="{{['未知', '男', '女']}}" 
                    bindchange="handleInput" data-field="gender">
              <view class="edit-input">{{genderMap[editForm.gender]}}</view>
            </picker>
          </view>

          <view class="info-item">
            <text class="label">生日</text>
            <view wx:if="{{!isEditing || editingField !== 'birthday'}}" 
                  class="value {{!user.birthday ? 'placeholder' : ''}}" 
                  bindtap="startEditField" data-field="birthday">
              {{user.birthday || '未设置'}}
            </view>
            <picker wx:else mode="date" value="{{editForm.birthday}}" 
                    bindchange="handleInput" data-field="birthday">
              <view class="edit-input">{{editForm.birthday || '选择日期'}}</view>
            </picker>
          </view>
        </view>
      </view>

      <!-- Contact Info -->
      <view class="info-card">
        <view class="card-title">联系信息</view>
        <view class="info-grid">
          <view class="info-item">
            <text class="label">邮箱</text>
            <view wx:if="{{!isEditing || editingField !== 'email'}}" 
                  class="value {{!user.email ? 'placeholder' : ''}}" 
                  bindtap="startEditField" data-field="email">
              {{user.email || '未设置'}}
            </view>
            <input wx:else class="edit-input" value="{{editForm.email}}" 
                   bindinput="handleInput" data-field="email" focus />
          </view>

          <view class="info-item">
            <text class="label">微信号</text>
            <view wx:if="{{!isEditing || editingField !== 'wechat'}}" 
                  class="value {{!user.wechat ? 'placeholder' : ''}}" 
                  bindtap="startEditField" data-field="wechat">
              {{user.wechat || '未设置'}}
            </view>
            <input wx:else class="edit-input" value="{{editForm.wechat}}" 
                   bindinput="handleInput" data-field="wechat" focus />
          </view>
        </view>
      </view>

      <!-- Rental Preferences -->
      <view class="info-card">
        <view class="card-title">租房偏好</view>
        <view class="info-grid">
          <view class="info-item">
            <text class="label">最低预算</text>
            <view wx:if="{{!isEditing || editingField !== 'rentalBudgetMin'}}" 
                  class="value {{!user.rentalBudgetMin ? 'placeholder' : ''}}" 
                  bindtap="startEditField" data-field="rentalBudgetMin">
              {{user.rentalBudgetMin ? user.rentalBudgetMin : '未设置'}}
            </view>
            <input wx:else class="edit-input" type="number" value="{{editForm.rentalBudgetMin}}" 
                   bindinput="handleInput" data-field="rentalBudgetMin" focus />
          </view>

          <view class="info-item">
            <text class="label">最高预算</text>
            <view wx:if="{{!isEditing || editingField !== 'rentalBudgetMax'}}" 
                  class="value {{!user.rentalBudgetMax ? 'placeholder' : ''}}" 
                  bindtap="startEditField" data-field="rentalBudgetMax">
              {{user.rentalBudgetMax ? user.rentalBudgetMax : '未设置'}}
            </view>
            <input wx:else class="edit-input" type="number" value="{{editForm.rentalBudgetMax}}" 
                   bindinput="handleInput" data-field="rentalBudgetMax" focus />
          </view>

          <view class="info-item full-width">
            <text class="label">偏好区域</text>
            <view wx:if="{{!isEditing || editingField !== 'preferredDistricts'}}" 
                  class="value {{!user.preferredDistricts ? 'placeholder' : ''}}" 
                  bindtap="startEditField" data-field="preferredDistricts">
              {{user.preferredDistricts || '未设置'}}
            </view>
            <input wx:else class="edit-input" value="{{editForm.preferredDistricts}}" 
                   bindinput="handleInput" data-field="preferredDistricts" focus />
          </view>

          <view class="info-item full-width">
            <text class="label">租房需求</text>
            <view wx:if="{{!isEditing || editingField !== 'houseRequirements'}}" 
                  class="value {{!user.houseRequirements ? 'placeholder' : ''}}" 
                  bindtap="startEditField" data-field="houseRequirements">
              {{user.houseRequirements || '未设置'}}
            </view>
            <textarea wx:else class="edit-textarea" value="{{editForm.houseRequirements}}" 
                      bindinput="handleInput" data-field="houseRequirements" focus auto-height />
          </view>
        </view>
      </view>

    </view>
  </scroll-view>
</view>