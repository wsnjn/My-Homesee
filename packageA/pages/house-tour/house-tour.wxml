<!--pages/house-tour/house-tour.wxml-->
<view class="page-container">
  
  <!-- 上部分：VR Canvas (85%高度) -->
  <view class="vr-container">
    <canvas 
      type="webgl" 
      id="webgl" 
      class="vr-canvas"
      bindtouchstart="onTouchStart" 
      bindtouchmove="onTouchMove" 
      bindtouchend="onTouchEnd"
    ></canvas>

    <!-- 悬浮UI层 (使用 cover-view) -->
    <!-- 悬浮UI层 (使用 view + pointer-events: none 实现穿透) -->
    <view class="float-ui" style="pointer-events: none;">
      <!-- 场景/状态信息 -->
      <view class="scene-info" wx:if="{{currentScene && !loading}}" style="pointer-events: auto;">
        <text class="scene-info-text">{{currentScene.scene.title || '未知场景'}}</text>
      </view>

      <!-- 聊天消息气泡 (独立于下方聊天框，悬浮在画面上) -->
      <view class="chat-bubbles-container" wx:if="{{!assistantCollapsed}}" style="pointer-events: auto;">
        <scroll-view class="chat-scroll-view" scroll-y="{{true}}" scroll-into-view="{{scrollToMessageId}}">
          <view class="message assistant" id="msg-0">
             <view class="bubble">👋 您好！您可以问我关于这套房源的任何问题。</view>
          </view>
          <view 
            class="message {{item.role}}" 
            wx:for="{{messages}}" 
            wx:key="index"
            id="msg-{{index + 1}}"
          >
            <view class="bubble">{{item.content}}</view>
          </view>
        </scroll-view>
      </view>

      <!-- Loading/Error -->
      <view class="status-overlay" wx:if="{{loading || error}}" style="pointer-events: auto;">
        <view class="status-text" wx:if="{{loading}}">Loading...</view>
        <view class="status-text error" wx:if="{{error}}">{{error}}</view>
         <button class="retry-btn" bindtap="onRetry" wx:if="{{error}}">重试</button>
      </view>
    </view>
  </view>

  <!-- 下部分：操作栏 (15%高度, 普通视口) -->
  <view class="bottom-dock">
    
    <!-- 1. 默认状态：功能按钮 -->
    <view class="dock-default" wx:if="{{!showControls && assistantCollapsed}}">
      <view class="dock-btn scenes-btn" bindtap="toggleControls">
        <svg-icon name="vr-card" size="24" color="#FFFFFF" />
        <text>切换场景</text>
      </view>
      <view class="dock-info">
        <text class="dock-tips">拖动屏幕旋转视角</text>
      </view>
      <view class="dock-btn ai-btn" bindtap="toggleAssistant">
        <svg-icon name="ai-sparkle" size="24" color="#FFFFFF" />
        <text>AI助手</text>
      </view>
    </view>

    <!-- 2. 场景选择模式 -->
    <view class="dock-scenes" wx:if="{{showControls}}">
      <view class="dock-header">
        <text>选择场景</text>
        <view class="close-btn" bindtap="toggleControls">×</view>
      </view>
      <scroll-view scroll-x class="scene-scroller">
        <view class="scene-track">
          <view 
            wx:for="{{naviData}}" 
            wx:key="index"
            class="dock-scene-item {{currentSceneIndex === index ? 'active' : ''}}"
            catchtap="onSceneSelect"
            data-index="{{index}}"
          >
            <image class="dock-thumb" src="{{item.scene.sphereSource.thumb || item.scene.sphereSource.url}}" mode="aspectFill" />
            <text class="dock-scene-title">{{item.scene.title}}</text>
          </view>
        </view>
      </scroll-view>
    </view>

    <!-- 3. AI 助手模式 (输入框) -->
    <view class="dock-chat" wx:if="{{!assistantCollapsed}}">
      <view class="chat-input-row">
        <view class="close-btn mini" bindtap="toggleAssistant">×</view>
        <input 
          class="dock-input" 
          placeholder="问问AI关于这套房..." 
          value="{{inputText}}"
          bindinput="onInput"
          bindconfirm="sendMessage"
          confirm-type="send"
          cursor-spacing="20"
        />
        <view class="send-btn {{!inputText ? 'disabled' : ''}}" bindtap="sendMessage">
          <text>发送</text>
        </view>
      </view>
    </view>

  </view>
</view>
